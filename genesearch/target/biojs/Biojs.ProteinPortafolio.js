
Biojs.ProteinPortafolio=Biojs.extend({constructor:function(options){var self=this;Biojs.console.enable();this._container=jQuery("#"+self.opt.target);this._initialize();if(!Biojs.Utils.isEmpty(options.accession)){this.setProtein(options.accession);}},opt:{target:"YourOwnDivId",accession:"",mappingUrl:'http://www.ebi.ac.uk/pdbe-apps/widgets/unipdb?uniprot=',featuresUrl:'http://www.ebi.ac.uk/das-srv/uniprot/das/uniprot-summary/features',proxyUrl:'../biojs/dependencies/proxy/proxy.php',jmolFolder:'../biojs/dependencies/jmol-12.0.48'},eventTypes:["onClick","onPdbSelected"],setSize:function(size){},_initialize:function(){this._alpha=jQuery('<div class="alpha"></div>').appendTo(this._container);this._beta=jQuery('<div class="beta"></div>').appendTo(this._container);this._header=jQuery('<div class="header"></div>').appendTo(this._alpha);this._toolbar=jQuery('<div class="toolbar"></div>').appendTo(this._alpha);this._content=jQuery('<div class="content"></div>').appendTo(this._alpha);this._content.attr('id','ProteinPortafolio_content_'+this.getId());this._container.addClass('ProteinPortafolio');},_clearAll:function(){this._header.children().remove();this._toolbar.children().remove();this._content.children().remove();},setProtein:function(accession){this.opt.accession=accession;this._requestAligments(accession,function(alignments){this._alignments=alignments;this._container.removeClass('loading');if(!Biojs.Utils.isEmpty(alignments)){this._setHeader(this.opt.accession,this._createPDBSelect(alignments));}else{this._setHeader(this.opt.accession);}});this._showFeatures(accession);},_requestAligments:function(accession,action){var self=this;this._clearAll();this._container.addClass('loading');var xhr=jQuery.ajax({url:self.opt.mappingUrl+accession,data:{biojsmapping:'1',varname:'pdbmappings'},dataType:"script",crossDomain:true,timeout:5000,success:function(){Biojs.console.log("SUCCESS: data received");self._alignments=pdbmappings;action.call(self,pdbmappings);},async:true,error:function(qXHR,textStatus,errorThrown){Biojs.console.log("ERROR: "+textStatus);self.raiseEvent('onRequestError',{message:textStatus});action.call(self,{});}});},_createPDBSelect:function(alignments){var pdbOptions="";for(pdb in alignments){text=pdb+" ("+alignments[pdb][1].start+".."+alignments[pdb][1].end+")";pdbOptions+='<option value="'+text+'">'+text+'</option>';}
Biojs.console.log("_createOptions: "+pdbOptions);return pdbOptions;},_setHeader:function(accession,mappingsSelector){var self=this;if(mappingsSelector!==undefined){this._header.html("Accession: "+accession+", PDB Alignments: <select>"+mappingsSelector+"</select>");this._onAlignmentSelectionChange();this._header.children('select').change(function(){self._onAlignmentSelectionChange()});}else{this._header.html("Accession: "+accession+", No PDB alignments found.");}
this._adjustContentSize();},_onAlignmentSelectionChange:function(){var alignment=this.getCurrentAlignment();if(!Biojs.Utils.isEmpty(alignment)){this.raiseEvent('onPdbSelected',{"pdbId":alignment.pdbId,"alignmentId":alignment.alignmentId,"start":alignment.start,"end":alignment.end});this._showPDBPrints(alignment.pdbId);this._showImage(alignment.pdbId);this._showFeatures(this.opt.accession);}else{Biojs.console.log("No structural information available for "+this.opt.accession);}},_showPDBPrints:function(pdbId){var self=this;this._toolbar.children().remove();this._toolbar.attr('id','PDBLogos_toolbar_'+this.getId());var myprints=new Biojs.PDBLogos({target:this._toolbar.attr('id'),identifier:pdbId});myprints.onClick(function(e){if(e.category=="PDBStructure"){self._showProtein3D();}else{window.open(e.printsURL);}});this._adjustContentSize();},getAlignmentsByPdb:function(pdbId){var alignments={};for(al in this._alignments){if(this._alignments[al][0].intObjectId.indexOf(pdbId)!=-1){alignments[this._alignments[al][0].intObjectId]=this._alignments[al];}}
Biojs.console.log("Alignments for pdb "+pdbId);Biojs.console.log(alignments);return alignments;},getCurrentAlignment:function(){var result={};var pdbSelectedValue=this._header.find('select').val();if(pdbSelectedValue!=undefined){result.accession=this.opt.accession;result.alignmentId=pdbSelectedValue.substring(0,pdbSelectedValue.indexOf(' '));result.pdbId=pdbSelectedValue.substring(0,pdbSelectedValue.indexOf('.')).toLowerCase();var alignment=this.getAlignmentsByPdb(result.alignmentId);result.start=alignment[result.alignmentId][1].start;result.end=alignment[result.alignmentId][1].end;result.offset=0;if(alignment.hasOwnProperty(result.alignmentId)){result.offset=result.start-alignment[result.alignmentId][0].start;}
result.alignment=alignment;}
Biojs.console.log("Current alignment");Biojs.console.log(result);return result;},_showProtein3D:function(){var self=this;var alignment=this.getCurrentAlignment();var height=this._container.height()-this._header.height()-this._toolbar.height();self._content.children().remove();self._beta.children().remove();self._beta.attr('id','biojs_protein3D_'+self._content.attr('id'));var test=jQuery("<span>X</span>").appendTo(self._content);var columns=Math.round(self._content.width()*(1/test.width()));test.remove();var sequence=new Biojs.Sequence({target:self._content.attr('id'),format:'FASTA',id:alignment.accession,formatSelectorVisible:false,columns:{size:columns,spacedEach:10}});var proteinStructure=new Biojs.Protein3DWS({id:alignment.pdbId,target:self._beta.attr('id'),width:Math.round(self._beta.width()),height:self._container.height(),proxyUrl:self.opt.proxyUrl,jmolFolder:self.opt.jmolFolder});sequence.onSelectionChange(function(e){var selection={start:e.start,end:e.end};selection.start-=alignment.offset;selection.end-=alignment.offset;proteinStructure.setSelection(selection);});},_showSequence:function(accession){var self=this;this._content.children().remove();var sequence=new Biojs.Sequence({target:this._content.attr('id'),format:'FASTA',id:accession,formatSelectorVisible:false,columns:{size:Math.round(self._content.width()/20),spacedEach:10}});},_showImage:function(pdbId){this._beta.children().remove();var img=jQuery('<img src="http://www.ebi.ac.uk/pdbe-srv/view/images/entry/'+pdbId+'_cbc600.png"/>').appendTo(this._beta).addClass('crop');},_showFeatures:function(accession){var self=this;this._content.children().remove();this._adjustContentSize();this._requestFeatures(accession,function(xml){Biojs.console.log("Features received "+xml);var xmlDoc="";try{xmlDoc=jQuery.parseXML(xml);}catch(e){Biojs.console.log("XML parser error"+e);}
var features=jQuery('<ul class="features"></ul>').appendTo(self._content);var label="",value="";jQuery(xmlDoc).find('FEATURE').each(function(){label='<span class="label">'+jQuery(this).attr('label')+'</span>';value='<span class="value">'+jQuery(this).children('NOTE:first').text()+'</span>';features.append('<li>'+label+value+'</li>');});});},_requestFeatures:function(accession,action){var self=this;Biojs.console.log("Requesting features for '"+accession+"'");var httpRequest={url:self.opt.proxyUrl,data:[{name:"url",value:self.opt.featuresUrl+"?segment="+accession}],method:"GET",dataType:"text",success:action,error:function(e){Biojs.console.log("Error requesting features for "+accession);}};jQuery.ajax(httpRequest);},_adjustContentSize:function(){if(this._beta.children().length>0){this._alpha.addClass('alpha');this._beta.addClass('beta');this._content.height(this._container.height()-this._header.height()-this._toolbar.height());}else{this._alpha.removeClass('alpha');this._beta.removeClass('beta');this._content.height('auto');}}});