
Biojs.Sequence=Biojs.extend({constructor:function(options){var self=this;this._container=jQuery("#"+this.opt.target);this._container.ready(function(){self._initialize();});},opt:{sequence:"",id:"",target:"",format:"FASTA",selection:{start:0,end:0},columns:{size:35,spacedEach:10},highlights:[],annotations:[],sequenceUrl:'http://www.ebi.ac.uk/das-srv/uniprot/das/uniprot/sequence',selectionColor:'Yellow',selectionFontColor:'black',highlightFontColor:'red',highlightBackgroundColor:'white',fontFamily:'"Andale mono", courier, monospace',fontSize:'12px',fontColor:'inherit',backgroundColor:'inherit',width:undefined,height:undefined,formatSelectorVisible:true},eventTypes:["onSelectionChanged","onSelectionChange","onAnnotationClicked"],_headerDiv:null,_contentDiv:null,_initialize:function(){if(this.opt.width!==undefined){this._container.width(this.opt.width);}
if(this.opt.height!==undefined){this._container.height(this.opt.height);}
this._container.css({'-moz-user-select':'none','-webkit-user-select':'none','user-select':'none'});this._buildFormatSelector();this._contentDiv=jQuery('<div></div>').appendTo(this._container);this._contentDiv.css({'font-family':this.opt.fontFamily,'font-size':this.opt.fontSize,'text-align':'left'});this._highlights=this.opt.highlights;this._annotations=this.opt.annotations;jQuery('<div id="sequenceTip'+this.getId()+'"></div>').css({'position':"absolute",'z-index':"999999",'color':"#fff",'font-size':"12px",'width':"auto",'display':'none'}).addClass("tooltip").appendTo("body").hide();if(!Biojs.Utils.isEmpty(this.opt.sequence)){this._redraw();}else if(!Biojs.Utils.isEmpty(this.opt.id)){this._requestSequence(this.opt.id);}else{this.clearSequence("No sequence available","../biojs/css/images/warning_icon.png");}},setSequence:function(seq,identifier){if(seq.match(/^[A-z]([0-9])*$/g)){this._requestSequence(arguments[0]);}else{this.opt.sequence=seq;this.opt.id=identifier;this._highlights=[];this._highlightsCount=0;this.opt.selection={start:0,end:0};this._annotations=[];this._contentDiv.children().remove();this._redraw();}},_requestSequence:function(accession){var self=this;this._contentDiv.addClass('loading');Biojs.console.log("Requesting sequence for: "+accession);jQuery.ajax({url:self.opt.sequenceUrl,dataType:"xml",data:{segment:accession},success:function(xml){try{var sequenceNode=jQuery(xml).find('SEQUENCE:first');self.setSequence(sequenceNode.text(),sequenceNode.attr("id"),sequenceNode.attr("label"));}catch(e){Biojs.console.log("Error decoding response data: "+e.message);self.clearSequence("No sequence available","../biojs/css/images/warning_icon.png");}},error:function(jqXHR,textStatus,errorThrown){Biojs.console.log("Error decoding response data: "+textStatus);self.clearSequence("Error requesting the sequence to the server "+this.url,"../biojs/css/images/warning_icon.png");}});},clearSequence:function(showMessage,icon){var message=undefined;this.opt.sequence="";this.opt.id="";this._highlights=[];this._highlightsCount=0;this.opt.selection={start:0,end:0};this._annotations=[];this._contentDiv.children().remove();this._headerDiv.hide();if(undefined!==showMessage){message=jQuery('<div>'+showMessage+'</div>').appendTo(this._contentDiv).addClass("message");if(undefined!==icon){message.css({'background':'transparent url("'+icon+'") no-repeat center left','padding-left':'20px'});}}},setSelection:function(start,end){if(start>end){var aux=end;end=start;start=aux;}
if(start!=this.opt.selection.start||end!=this.opt.selection.end){this._setSelection(start,end);this.raiseEvent(Biojs.Sequence.EVT_ON_SELECTION_CHANGED,{"start":start,"end":end});}},_buildFormatSelector:function(){var self=this;this._headerDiv=jQuery('<div></div>').appendTo(this._container);this._headerDiv.css({'font-family':'"Heveltica Neue", Arial, "sans serif"','font-size':'14px'}).append('Format: ');this._formatSelector=jQuery('<select> '+'<option value="FASTA">FASTA</option>'+'<option value="CODATA">CODATA</option>'+'<option value="PRIDE">PRIDE</option>'+'<option value="RAW">RAW</option></select>').appendTo(self._headerDiv);this._formatSelector.change(function(e){self.opt.format=jQuery(this).val();self._redraw();});this._formatSelector.val(self.opt.format);this.formatSelectorVisible(this.opt.formatSelectorVisible);},highlight:function(start,end,color,background,id){return this.addHighlight({"start":start,"end":end,"color":color,"background":background,"id":id});},addHighlight:function(h){var id='-1';var color="";var background="";var highlight={};if(h instanceof Object&&h.start<=h.end){color=("string"==typeof h.color)?h.color:this.opt.highlightFontColor;background=("string"==typeof h.background)?h.background:this.opt.highlightBackgroundColor;id=("string"==typeof h.id)?h.id:(new Number(this._highlightsCount++)).toString();highlight={"start":h.start,"end":h.end,"color":color,"background":background,"id":id};this._highlights.push(highlight);this._applyHighlight(highlight);this._restoreSelection(h.start,h.end);}
return id;},_applyHighlight:function(highlight){var seq=this._contentDiv.find('.sequence');for(var i=highlight.start-1;i<highlight.end;i++){jQuery(seq[i]).css({"color":highlight.color,"background-color":highlight.background}).addClass("highlighted");}},_applyHighlights:function(highlights){for(var i in highlights){this._applyHighlight(highlights[i]);}},_restoreHighlights:function(start,end){var h=this._highlights;this._applyHighlight({"start":start,"end":end,"color":this.opt.fontColor,"background":this.opt.backgroundColor});for(var i in h){if(!(h[i].start>end||h[i].end<start)){a=(h[i].start<start)?start:h[i].start;b=(h[i].end>end)?end:h[i].end;this._applyHighlight({"start":a,"end":b,"color":h[i].color,"background":h[i].background});}}},_restoreSelection:function(start,end){var sel=this.opt.selection;if(!(start>sel.end||end<sel.start)){a=(start<sel.start)?sel.start:start;b=(end>sel.end)?sel.end:end;this._applyHighlight({"start":a,"end":b,"color":this.opt.selectionFontColor,"background":this.opt.selectionColor});}},unHighlight:function(id){this.removeHighlight(id);},removeHighlight:function(id){var h=this._highlights;for(i in h){if(h[i].id==id){start=h[i].start;end=h[i].end;h.splice(i,1);this._restoreHighlights(start,end);this._restoreSelection(start,end);break;}}},unHighlightAll:function(){this.removeAllHighlights();},removeAllHighlights:function(){this._highlights=[];this._restoreHighlights(1,this.opt.sequence.length);this._restoreSelection(1,this.opt.sequence.length);},setFormat:function(format){if(this.opt.format!=format.toUpperCase()){this.opt.format=format.toUpperCase();this._redraw();}
var self=this;this._headerDiv.find('option').each(function(){if(jQuery(this).val()==self.opt.format.toUpperCase()){jQuery(this).attr('selected','selected');}});},setNumCols:function(numCols){this.opt.columns.size=numCols;this._redraw();},formatSelectorVisible:function(visible){if(visible){this._headerDiv.show();}else{this._headerDiv.hide();}},showFormatSelector:function(){this._headerDiv.show();},hideFormatSelector:function(){this._headerDiv.hide();},hide:function(){this._headerDiv.hide();this._contentDiv.hide();},show:function(){this._headerDiv.show();this._contentDiv.show();},_setSelection:function(start,end){var current=this.opt.selection;var change={};if(current.start==start){if(current.end<end){change.start=current.end;change.end=end;}else{this._restoreHighlights(end,current.end);}}else if(current.end==end){if(current.start<start){this._restoreHighlights(current.start,start);}else{change.start=start;change.end=current.start;}}else{this._restoreHighlights(current.start,current.end);change.start=start;change.end=end;}
current.start=start;current.end=end;if(change.start!=undefined){this._applyHighlight({"start":change.start,"end":change.end,"color":this.opt.selectionFontColor,"background":this.opt.selectionColor});}},_repaintSelection:function(){var s=Biojs.Utils.clone(this.opt.selection);this._setSelection(0,0);this._setSelection(s.start,s.end);},_redraw:function(){var i=0;var self=this;this._contentDiv.children().remove();this._contentDiv.removeClass('loading');if(this.opt.format=='RAW'){this._drawRaw();}else if(this.opt.format=='CODATA'){this._drawCodata();}else if(this.opt.format=='FASTA'){this._drawFasta();}else{this.opt.format='PRIDE';this._drawPride();}
this._applyHighlights(this._highlights);this._repaintSelection();this._addSpanEvents();},_drawFasta:function(){var self=this;var a=this.opt.sequence.toUpperCase().split('');var pre=jQuery('<pre></pre>').appendTo(this._contentDiv);var i=1;var arr=[];var str='>'+this.opt.id+' '+a.length+' bp<br/>';var opt={numCols:self.opt.columns.size,numColsForSpace:self.opt.columns.spacedEach};str+=this._drawSequence(a,opt);pre.html(str);this._drawAnnotations(opt);},_drawCodata:function(){var self=this;var a=this.opt.sequence.toUpperCase().split('');var pre=jQuery('<pre style="white-space:pre"></pre>').appendTo(this._contentDiv);var i=0;var str='ENTRY           '+this.opt.id+'<br/>';str+='SEQUENCE<br/>';var opt={numLeft:true,numLeftSize:7,numLeftPad:' ',numTop:true,numTopEach:5,numCols:self.opt.columns.size,numColsForSpace:0,spaceBetweenChars:true};str+=this._drawSequence(a,opt);str+='<br/>///'
pre.html(str);this._drawAnnotations(opt);},_drawAnnotations:function(settings){var self=this;var a=this.opt.sequence.toLowerCase().split('');var annotations=this._annotations;var leftSpaces='';var row='';var annot='';if(settings.numLeft){leftSpaces+=this._formatIndex(' ',settings.numLeftSize+2,' ');}
for(var i=0;i<a.length;i+=settings.numCols){row='';for(var key in annotations){annotations[key].id=key;annot=this._getHTMLRowAnnot(i+1,annotations[key],settings);if(annot.length>0){row+='<br/>';row+=leftSpaces;row+=annot;row+='<br/>';}}
if(settings.numRight){jQuery(row).insertAfter('div#'+self.opt.target+' div pre span#numRight'+(i+settings.numCols));}else{jQuery(row).insertAfter('div#'+self.opt.target+' div pre span#'+(i+settings.numCols));}}
jQuery(this._contentDiv).find('.annotation').each(function(){self._addToolTip(this,function(){return self._getAnnotationString(jQuery(this).attr("id"));});jQuery(this).mouseover(function(e){jQuery('.annotation.'+jQuery(e.target).attr("id")).each(function(){jQuery(this).css("background-color",jQuery(this).attr("color"));});}).mouseout(function(){jQuery('.annotation').css("background-color","white");}).click(function(e){self.raiseEvent(Biojs.Sequence.EVT_ON_ANNOTATION_CLICKED,{"name":self._annotations[jQuery(e.target).attr("id")].name,"pos":parseInt(jQuery(e.target).attr("pos"))});});});},_getAnnotationString:function(id){var annotation=this._annotations[id];return annotation.name+"<br/>"+((annotation.html)?annotation.html:'');},_getHTMLRowAnnot:function(currentPos,annotation,settings){var styleBegin='border-left:1px solid; border-bottom:1px solid; border-color:';var styleOn='border-bottom:1px solid; border-color:';var styleEnd='border-bottom:1px solid; border-right:1px solid; border-color:';var row=[];var end=(currentPos+settings.numCols);var spaceBetweenChars=(settings.spaceBetweenChars)?' ':'';var defaultColor=annotation.color;var id=annotation.id;for(var pos=currentPos;pos<end;pos++){for(var r in annotation.regions){region=annotation.regions[r];spaceAfter='';spaceAfter+=(pos%settings.numColsForSpace==0)?' ':'';spaceAfter+=spaceBetweenChars;color=((region.color)?region.color:defaultColor);data='class="annotation '+id+'" id="'+id+'" color="'+color+'" pos="'+pos+'"';if(pos==region.start){row[pos]='<span style="'+styleBegin+color+'" '+data+'> ';row[pos]+=spaceAfter;row[pos]+='</span>';}else if(pos==region.end){row[pos]='<span style="'+styleEnd+color+' " '+data+'> ';row[pos]+='</span>';}else if(pos>region.start&&pos<region.end){row[pos]='<span style="'+styleOn+color+'" '+data+'> ';row[pos]+=spaceAfter;row[pos]+='</span>';}else if(!row[pos]){row[pos]=' ';row[pos]+=spaceAfter;}}}
var str=row.join("");return(str.indexOf("span")==-1)?"":str;},_drawRaw:function(){var self=this;var a=this.opt.sequence.toLowerCase().split('');var i=0;var arr=[];var pre=jQuery('<pre></pre>').appendTo(this._contentDiv);var opt={numCols:self.opt.columns.size};pre.html(this._drawSequence(a,opt));this._drawAnnotations(opt);},_drawPride:function(){var self=this;var a=this.opt.sequence.toUpperCase().split('');var pre=jQuery('<pre></pre>').appendTo(this._contentDiv);opt={numLeft:true,numLeftSize:5,numLeftPad:'0',numRight:true,numRightSize:5,numRightPad:'0',numCols:self.opt.columns.size,numColsForSpace:self.opt.columns.spacedEach};pre.html(this._drawSequence(a,opt));this._drawAnnotations(opt);},_drawSequence:function(a,opt){var str='';var spaceStyle="white-space: pre;";if(opt.numTop)
{str+='<span style="'+spaceStyle+'" class="numTop">'
var size=(opt.spaceBetweenChars)?opt.numTopEach*2:opt.numTopEach;if(opt.numLeft){str+=this._formatIndex(' ',opt.numLeftSize,' ');}
str+=this._formatIndex(' ',size,' ');for(var x=opt.numTopEach;x<opt.numCols;x+=opt.numTopEach){str+=this._formatIndex(x,size,' ',true);}
str+='</span><br/>'}
if(opt.numLeft){str+=this._formatIndex(1,opt.numLeftSize,opt.numLeftPad);str+='  ';}
var j=1;for(var i=1;i<=a.length;i++){if(i%opt.numCols==0){str+='<span class="sequence" id="'+i+'">'+a[i-1]+'</span>';if(opt.numRight){str+='<span style="'+spaceStyle+'" id="numRight'+i+'">';str+='  ';str+=this._formatIndex(i,opt.numRightSize,opt.numRightPad);str+='</span>';}
str+='<br/>';if(opt.numLeft){str+='<span id="numLeft'+i+'">';str+=this._formatIndex(i+1,opt.numLeftSize,opt.numLeftPad);str+='  ';str+='</span>';}
j=1;}else{str+='<span class="sequence" style="'+spaceStyle+'" id="'+i+'">'+a[i-1];str+=(j%opt.numColsForSpace==0)?' ':'';str+=(opt.spaceBetweenChars)?' ':'';str+='</span>';j++;}}
str+='<br/>'
if(jQuery.browser.msie){str="<pre>"+str+"</pre>";}
return str;},_formatIndex:function(number,size,fillingChar,alignLeft){var str=number.toString();var filling='';var padding=size-str.length;if(padding>0){while(padding-->0){filling+=("<span>"+fillingChar+"</span>");}
if(alignLeft){str=number+filling;}else{str=filling+number;}}
return str;},_addSpanEvents:function(){var self=this;var isMouseDown=false;var currentPos;self._contentDiv.find('.sequence').each(function(){jQuery(this).mousedown(function(){currentPos=parseInt(jQuery(this).attr('id'));clickPos=currentPos;self._setSelection(clickPos,currentPos);isMouseDown=true;self.raiseEvent(Biojs.Sequence.EVT_ON_SELECTION_CHANGE,{"start":self.opt.selection.start,"end":self.opt.selection.end});}).mouseover(function(){currentPos=parseInt(jQuery(this).attr('id'));if(isMouseDown){if(currentPos>clickPos){self._setSelection(clickPos,currentPos);}else{self._setSelection(currentPos,clickPos);}
self.raiseEvent(Biojs.Sequence.EVT_ON_SELECTION_CHANGE,{"start":self.opt.selection.start,"end":self.opt.selection.end});}}).mouseup(function(){isMouseDown=false;self.raiseEvent(Biojs.Sequence.EVT_ON_SELECTION_CHANGED,{"start":self.opt.selection.start,"end":self.opt.selection.end});});self._addToolTip.call(self,this,function(){if(isMouseDown){return"["+self.opt.selection.start+", "+self.opt.selection.end+"]";}else{return currentPos;}});}).css('cursor','pointer');},_addToolTip:function(target,cbGetMessageFunction){var tipId='#sequenceTip'+this.getId();jQuery(target).mouseover(function(e){var offset=jQuery(e.target).offset();if(!jQuery(tipId).is(':visible')){jQuery(tipId).css({'background-color':"#000",'padding':"3px 10px 3px 10px",'top':offset.top+jQuery(e.target).height()+"px",'left':offset.left+jQuery(e.target).width()+"px"}).animate({opacity:'0.85'},10).html(cbGetMessageFunction.call(target)).show();}}).mouseout(function(){jQuery(tipId).hide();});},setAnnotation:function(annotation){this.addAnnotation(annotation);},addAnnotation:function(annotation){this._annotations.push(annotation);this._redraw();},removeAnnotation:function(name){for(var i=0;i<this._annotations.length;i++){if(name!=this._annotations[i].name){this._annotations.splice(i,1);this._redraw();break;}}},removeAllAnnotations:function(){this._annotations=[];this._redraw();}},{EVT_ON_SELECTION_CHANGE:"onSelectionChange",EVT_ON_SELECTION_CHANGED:"onSelectionChanged",EVT_ON_ANNOTATION_CLICKED:"onAnnotationClicked"});